namespace = tributaries

#Clear "Roadblocks"

#Copy old Ruler tributaries list to his primary heir (on_death)
#Root is old ruler
tributaries.1 = {
	type = character_event
	hidden = yes

	immediate = {
		every_in_list = {
			variable = permanent_tributaries
			root.primary_heir = {
				add_to_variable_list = { name = permanent_tributaries target = prev }
				set_variable = { name = suzerain value = this }
			}
			set_variable = { name = my_suzerain value = prev.primary_heir }
		}		
		every_in_list = {
			variable = non_permanent_tributaries
			remove_variable = my_suzerain
		}	
		remove_variable = suzerain
	}
}

#give the heir var:my_suzerain
#Root is old tributary
#on_death
tributaries.2 = {
	type = character_event
	hidden = yes

	immediate = {
		if = {
			limit = {
				exists = var:my_suzerain
				var:my_suzerain = {
					is_target_in_variable_list = { name = permanent_tributaries target = prev }
				}
			}
			var:my_suzerain = {
				root.primary_heir = { 
					set_variable = { name = my_suzerain value = prev }
				}
			}
			#move trib type + character income to the heir
			pass_tributary_type_to_heir = {
				SCOPE = this
				TYPE = var:tributary_type
				NEW_RULER = this.primary_heir
			}
		}
		if = {
			limit = {
				exists = var:my_suzerain
				var:my_suzerain = {
					is_target_in_variable_list = { name = non_permanent_tributaries target = prev }
				}
			}
			var:my_suzerain = {
				remove_list_variable = { name = non_permanent_tributaries target = prev }
				#remove_list_variable = { name = all_tributaries target = prev}
			}	

		}
	}
}

#Attacker may or may mot become new suzerain
#Root = scope:tributaries_slash_suzerain_war_winner
#scope:tributary_slash_suzerain_loser = scope:defender
tributaries.3 = {
	type = character_event
	hidden = yes
	
	scope:tributary_slash_suzerain_loser = {

		switch = {
			trigger = is_suzerain

			yes = {
				if = {
					limit = {
						AND = {
							is_independent_ruler = no
							is_landed = no
						}
					}
					every_in_list = {
						variable = permanent_tributaries
						
						set_variable = { name = my_suzerain value = root }
						root = {
							add_to_variable_list = { name = permanent_tributaries target = prev }
						}
					}
					clear_variable_list = permanent_tributaries
					clear_variable_list = non_permanent_tributaries
				}
			}
			no = {
				if = {
					limit = {
						is_landed = no
					}
					if = {
						limit = {
							is_permanent_tributary = {
								SUZERAIN = var:my_suzerain
								TRIBUTARY = this
							}
						}
						var:my_suzerain = {
							remove_list_variable = { name = permanent_tributaries target = prev }
							remove_list_variable = { name = all_tributaries target = prev }
						}
					}
					else = {
						var:my_suzerain = {
							remove_list_variable = { name = non_permanent_tributaries target = prev }
							remove_list_variable = { name = all_tributaries target = prev }
						}					
					}
				}
			}
		}
	}
}

#Suzerain no longer have any tributaries
#on_monthly_tribute
#Root is suzerain
tributaries.4 = {
	type = character_event
	hidden = yes

	trigger = {
		NOR = {
			is_suzerain = yes
			has_tributaries = yes
		}
	}
	
	immediate = {
		if = {
			limit = {
				NOT = {
					is_suzerain = yes
				}
			}		
		}
		if = {
			limit = {
				NOT = {
					has_permanent_tributaries = yes
				}
			}
			clear_variable_list = permanent_tributaries
		}
		else_if = {
			limit = {
				NOT = {
					has_non_permanent_tributaries = yes
				}
			}
			clear_variable_list = non_permanent_tributaries
		}
		else_if = {
			limit = {
				NAND = {
					has_permanent_tributaries = yes
					has_non_permanent_tributaries = yes
				}
			}
			clear_variable_list = permanent_tributaries
			clear_variable_list = non_permanent_tributaries
		}
	}
}


#Monthly income from tributes
#on_monthly_tribute
#Root is suzerain
tributaries.5 = {
	type = character_event
	hidden = yes

	immediate = {
		if = {
			limit = {
				has_non_permanent_tributaries = yes
			}
			every_in_list = {
				variable = non_permanent_tributaries
				pay_long_term_gold = { target = prev gold = { value = monthly_character_income multiply = var:tribute_gold_percent }}
				add_prestige = var:monthly_prestige_tributary
				add_piety = var:monthly_piety_tributary
				prev = {
					add_prestige = prev.var:monthly_prestige_suzerain
					add_piety = prev.var:monthly_piety_suzerain
				}
				
			}
		}
		if = {
			limit = {
				has_permanent_tributaries = yes
			}
			every_in_list = {
				variable = permanent_tributaries

				pay_long_term_gold = { target = prev gold = { value = monthly_character_income multiply = var:tribute_gold_percent }}
				add_prestige = var:monthly_prestige_tributary
				add_piety = var:monthly_piety_tributary
				prev = {
					add_prestige = prev.var:monthly_prestige_suzerain
					add_piety = prev.var:monthly_piety_suzerain
				}		
			}
		}
	}
}

#Suzerain is called to permanent tributary war
#on_war_started
#Root is suzerain
#call_to_arms_tribute is defender
tributaries.6 = {
	type = character_event
	title = tributary_6_tit
	desc = tributary_6_desc
	right_portrait = {
		character = call_to_arms_tribute
		animation = war_defender 

	}
	left_portrait = { 
		character = root
		animation = personality_rational 
	}

	option = {
		name = suzerain_joins_the_war
		add_piety = minor_piety_value
		scope:call_to_arms_tribute = {
			any_war = {
				limit = {
					root = {
						NOR = {
							is_at_war_as_defender = yes
							is_at_war_with = scope:call_to_arms_tribute
						}
					}
				}
				if = {
					limit = {
						scope:call_to_arms_tribute = {
							is_at_war_as_attacker = yes
						}
					}
					add_attacker = root
				}
				else_if = {
					limit = {
						scope:call_to_arms_tribute = {
							is_at_war_as_defender = yes
						}
					}
					add_defender = root
				}
				else = {
					debug_log = "Something broke, report to typical"
				}
			}
			trigger_event = { id = tributaries.8 } #tributary gets a positive response
		}	
	}

	option = {
		name = suzerain_refuses_to_join_war
		add_prestige = major_prestige_loss
		save_scope_as = former_suzerain
		scope:call_to_arms_tribute = {
			trigger_event = { id = tributaries.7 } #tributary gets a negative response
		}
	}
}

#Tribute gets negative a response from suzerain
#root is defender and former tribute
tributaries.7 = {
	type = character_event
	title = tributary_7_tit
	desc = tributary_7_desc
	right_portrait = {
		character = root
		animation = disapproval 
	}
	left_portrait = { 
		character = scope:former_suzerain
		animation = personality_dishonorable
	}

	option = { #stop paying tribute
		name = tribute_stop_war
		scope:former_suzerain = {
			remove_list_variable = { name = permanent_tributaries target = prev }
			remove_list_variable = { name = all_tributaries target = prev }
		}
		remove_variable = my_suzerain
	}
}

#Response from new trib
#Root is suzerain
tributaries.9 = {
	type = letter_event
	opening = {
		desc = tributaries.9_opening
	}
	desc = tributaries.9_desc
	sender = scope:trib

	immediate = {
		custom_tooltip = becomes_a_trib
	}

	option = {
		name = nice
	}
}	

#Response from new suzerain
#Root is new trib
tributaries.9.1 = {
	type = letter_event
	opening = {
		desc = tributaries.9_opening
	}
	desc = tributaries.9.1_desc
	sender = scope:my_suzerain

	immediate = {
		custom_tooltip = becomes_a_trib
	}

	option = {
		name = nice
	}
}	

#Response from ruler
#Root is suzerain
tributaries.11 = {
	type = letter_event
	opening = {
		desc = tributaries.11_opening
	}
	desc = tributaries.11_desc
	sender = scope:not_trib

	option = {
		name = no_trib_sad
	}
}

#Response from Ruler
#Root is nearly tributary
tributaries.12 = {
	type = letter_event
	opening = {
		desc = tributaries.12_opening
	}
	desc = tributaries.12_desc
	sender = scope:not_suzerain

	option = {
		name = tribute_denied
	}
}	

#Call to arms recived from suzerain
#Root is tributary
tributaries.13 = {
	type = letter_event
	opening = {
		desc = tributaries.13_opening
	}
	desc = tributaries.13_opening
	sender = scope:suzerain_cta_caller

	option = {
		name = join_suzerain_war
		scope:suzerain_cta_caller = {
			if = {
				limit = {
					is_attacker_in_war = yes
				}
				add_attacker = prev
			}
			if = {
				limit = {
					is_defender_in_war = yes
				}
				add_defender = prev
				
			}
		}
	}

	option = {
		name = do_not_join_suzerain_war
	}
}