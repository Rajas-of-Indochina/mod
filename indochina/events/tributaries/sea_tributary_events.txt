namespace = tributaries

# Death management: A Suzerain has died. Pass on their tributaries to the heir.
tributaries.0001 = {
    type = character_event
    hidden = yes
    trigger = {
        is_suzerain = yes
    }
    immediate = {
        save_scope_as = dead_suzerain
        primary_heir = {
            save_scope_as = new_suzerain
        }

        every_relation = {
            type = tributary
            add_to_list = tributaries_to_pass
        }

        every_in_list = {
            list = tributaries_to_pass
            set_relation_suzerain = scope:new_suzerain
        }
    }
}
# Death management: A tributary has died. Give their heir their tributary status
tributaries.0002 = {
    type = character_event
    hidden = yes
    trigger = {
        is_tributary = yes
    }
    immediate = {
        save_scope_as = dead_tributary
        primary_heir = {
            save_scope_as = new_tributary
        }

        every_relation = {
            type = suzerain
            add_to_list = suzerainties_to_pass
        }

        every_in_list = {
            list = suzerainties_to_pass
            set_relation_tributary = scope:new_tributary
        }
    }
}

#Clear "Roadblocks"

#Attacker may or may mot become new suzerain
#Root = scope:tributary_slash_suzerain_war_winner
#scope:tributary_slash_suzerain_loser = scope:defender

# ??????
tributaries.2003 = {
    type = character_event
    hidden = yes

    immediate = {
        scope:tributary_slash_suzerain_loser = {

            # Suzerain lost a war
            if = {
                limit = { is_suzerain = yes }

                if = {
                    limit = {
                        AND = {
                            is_independent_ruler = no
                            is_landed = no
                        }
                    }
                    every_relation = {
                        type = tributary
                        remove_relation_suzerain = PREV
                    }
                    clear_variable_list = permanent_tributaries
                    clear_variable_list = non_permanent_tributaries
                }
            }
            # Tributary lost a war
            else = {
                if = {
                    limit = {
                        is_landed = no
                    }
                    every_relation = {
                        type = suzerain
                        remove_relation_tributary = PREV
                    }
                }
            }
        }
    }
}

#Suzerain no longer have any tributaries
#on_monthly_tribute
#Root is suzerain
tributaries.2004 = {
    type = character_event
    hidden = yes

    immediate = {
        if = {
            limit = {
                has_tributaries = yes
            }

            save_scope_as = suzerain
            every_in_list = {
                variable = permanent_tributaries

                limit = {
                    OR = {
                        this = scope:suzerain
                        is_alive = no
                    }
                }

                remove_variable = my_suzerain
                scope:suzerain = {
                    remove_list_variable = { name = permanent_tributaries target = prev }
                    remove_list_variable = { name = all_tributaries target = prev }
                }
            }
        }

        if = {
            limit = {
                NOT = {
                    has_tributaries = yes
                }
            }
            clear_variable_list = permanent_tributaries
        }
    }
}


#Monthly income from tributes
#on_monthly_tribute
#Root is suzerain
tributaries.2005 = {
    type = character_event
    hidden = yes

    immediate = {
        if = {
            limit = {
                has_tributaries = yes
            }

            save_scope_as = suzerain
            every_relation = { type = tributary
                trigger_event = { id = tributaries.2006 }
            }
        }
    }
}

tributaries.2006 = {
    type = character_event
    title = tributary_event_send_tribute
    desc = tributary_event_send_tribute_desc
    theme = vassal

    right_portrait = {
        character = root
    }
    left_portrait = {
        character = scope:suzerain
        animation = personality_honorable
    }

    option = {
        name = tributary_send_gold
        save_scope_as = tributary

        scope:suzerain = {
            send_interface_message = {
                title = tributary_send_tribute.sent_gold
                type = event_tribute_paid
                desc = tributary_send_tribute.sent_gold_desc
                left_icon = root

                root = {
                    pay_long_term_gold = {
                        target = scope:suzerain
                        gold = {
                            value = yearly_character_income
                            multiply = 0.05
                            multiply = 3
                        }
                    }
                }
            }
        }
        ai_chance = { base = 100 }
    }
    option = {
        name = tributary_send_prestige
        add_prestige = medium_prestige_loss
        scope:suzerain = { add_prestige = medium_prestige_gain }
        ai_chance = { base = 0 }
    }
    option = {
        name = tributary_refuse_tribute
        save_scope_as = tributary

        scope:suzerain = {
            add_opinion = {
                modifier = insult_opinion
                opinion = -50
                target = root
            }
            trigger_event = { id = tributaries.2011 } # Suzerain may declare war
        }
        custom_tooltip = tributary_refuse_tribute.tt
        ai_chance = { base = 0 }
    }
}

tributaries.2011 = {
    type = letter_event
    opening = {
        desc = tributaries.2011_opening
    }
    desc = tributaries.2011_desc
    sender = scope:tributary

    option = {
        name = tributaries.2011.a
        ai_chance = { base = 66 }
    }
    option = {
        name = tributaries.2011.b
        ai_chance = { base = 33 }
        start_war = {
            casus_belli = tributary_punitive_war_cb
            target = scope:tributary
        }

        hidden_effect = {
            send_interface_toast = {
                type = msg_war_declared_on_me
                title = declare_war_interaction_notification

                left_icon = scope:actor
                right_icon = scope:not_trib

                custom_tooltip = declare_war_interaction_notification_tooltip
            }
        }
    }
}

#Suzerain is called to tributary war
#on_war_started
#Root is suzerain
#call_to_arms_tribute is defender
tributaries.2016 = {
    type = character_event
    theme = war
    title = tributary_6_tit
    desc = tributary_6_desc
    right_portrait = {
        character = scope:call_to_arms_tribute
        animation = war_defender
    }
    left_portrait = {
        character = root
        animation = personality_rational
    }

    trigger = {
        NOT = { scope:attacker = root }
        NOT = {
            is_target_in_global_variable_list = {
                name = permanent_tributaries
                target = scope:attacker
            }
        }
    }

    option = {
        name = suzerain_joins_the_war
        add_piety = minor_piety_value
        scope:call_to_arms_tribute = {
            # any_character_war = {
            random_character_war = {
                limit = {
                    root = {
                        NOR = {
                            is_at_war_as_defender = yes
                            is_at_war_with = scope:call_to_arms_tribute
                        }
                    }
                }
                if = {
                    limit = {
                        scope:call_to_arms_tribute = {
                            is_at_war_as_attacker = yes
                        }
                    }
                    add_attacker = root
                }
                else_if = {
                    limit = {
                        scope:call_to_arms_tribute = {
                            is_at_war_as_defender = yes
                        }
                    }
                    add_defender = root
                }
                else = {
                    debug_log = "Something broke, report to typical"
                }
            }
            # trigger_event = { id = tributaries.8 } #tributary gets a positive response
        }
        ai_chance = { base = 100 } # This should be more complex than this
    }

    option = {
        name = suzerain_refuses_to_join_war
        add_prestige = major_prestige_loss
        save_scope_as = former_suzerain
        scope:call_to_arms_tribute = {
            trigger_event = { id = tributaries.7 } #tributary gets a negative response
        }
        ai_chance = { base = 0 }
    }
}

#Tribute gets negative a response from suzerain
#root is defender and former tribute
tributaries.7 = {
    type = character_event
    theme = war
    title = tributary_7_tit
    desc = tributary_7_desc
    right_portrait = {
        character = root
        animation = disapproval
    }
    left_portrait = {
        character = scope:former_suzerain
        animation = personality_dishonorable
    }

    option = { #stop paying tribute
        name = tribute_stop_war
        scope:former_suzerain = {
            remove_list_variable = { name = permanent_tributaries target = prev }
            remove_list_variable = { name = all_tributaries target = prev }
        }
        remove_variable = my_suzerain
    }
}

#Response from new trib
#Root is suzerain
# Accepted becoming a tributary
tributaries.9 = {
    type = letter_event
    opening = {
        desc = tributaries.9_opening
    }
    desc = tributaries.9_desc
    sender = scope:trib

    immediate = {
        custom_tooltip = becomes_a_trib
    }

    option = {
        name = EXCELLENT

        scope:trib = {
            pay_long_term_gold = {
                target = root
                gold = {
                    value = yearly_character_income
                    multiply = 0.05
                    multiply = 3
                }
            }
        }
    }
}

# Accepted one time tribute payment
tributaries.10 = {
    type = letter_event
    opening = {
        desc = tributaries.10.opening
    }
    desc = tributaries.10.desc
    sender = scope:trib

    immediate = {
        custom_tooltip = becomes_a_trib
    }

    option = {
        name = tributaries.10.a
    }
}

# Denied one time tribute payment
tributaries.101 = {
    type = letter_event
    opening = {
        desc = tributaries.101.opening
    }
    desc = tributaries.101.desc
    sender = scope:not_trib

    option = {
        name = tributaries.101.a
        ai_chance = { base = 66 }
    }
    option = {
        name = tributaries.101.b
        ai_chance = { base = 33 }

        start_war = {
            cb = one_time_tributary_war_cb
            target = scope:not_trib
        }

        hidden_effect = {
            send_interface_toast = {
                type = msg_war_declared_on_me
                title = declare_war_interaction_notification

                left_icon = scope:actor
                right_icon = scope:not_trib

                custom_tooltip = declare_war_interaction_notification_tooltip
            }
        }
    }
}

#Response from new suzerain
#Root is new trib
tributaries.901 = {
    type = letter_event
    opening = {
        desc = tributaries.901_opening
    }
    desc = tributaries.901_desc
    sender = scope:my_suzerain

    immediate = {
        custom_tooltip = becomes_a_trib
    }

    option = {
        name = EXCELLENT
    }
}

#Response from ruler
#Root is suzerain
tributaries.11 = {
    type = letter_event
    opening = {
        desc = tributaries.11_opening
    }
    desc = tributaries.11_desc
    sender = scope:not_trib

    option = {
        name = no_trib_sad
        ai_chance = { base = 66 }
    }
    option = {
        name = no_trib_declare_war
        ai_chance = { base = 33 }

        start_war = {
            cb = permanent_tributary_war_cb
            target = scope:not_trib
        }

        hidden_effect = {
            send_interface_toast = {
                type = msg_war_declared_on_me
                title = declare_war_interaction_notification

                left_icon = scope:actor
                right_icon = scope:not_trib

                custom_tooltip = declare_war_interaction_notification_tooltip
            }
        }
    }
}

#Response from Ruler
#Root is nearly tributary
tributaries.12 = {
    type = letter_event
    opening = {
        desc = tributaries.12_opening
    }
    desc = tributaries.12_desc
    sender = scope:not_suzerain

    option = {
        name = tribute_denied
    }
}
