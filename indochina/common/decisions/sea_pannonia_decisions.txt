### Recreate the Avar Khaganate
restore_avar_khaganate_decision = {
	picture = "gfx/interface/illustrations/decisions/decision_destiny_goal.dds"
	major = yes
	desc = restore_avar_khaganate_decision_desc

	ai_check_interval = 120

	is_shown = {
		capital_county = {
			title_province = { geographical_region = custom_avar_heartland }
		}
		culture = {
			OR = {
				has_cultural_parameter = heritage_group_altaic
				has_cultural_parameter = heritage_group_mongolic
			}
		}
		NOT = {
			is_target_in_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:restore_avar_khaganate_decision
			}
		}
	}

	is_valid = {
		completely_controls_region = custom_avar_heartland
		OR = {
			AND = {
				title:e_carpathia = { is_title_created = no }
				highest_held_title_tier >= tier_kingdom
			}
			has_title = title:e_carpathia
		}
		prestige_level >= 3
		trigger_if = {
			limit = {
				has_governent = nomadic_government
			}
			has_realm_law = nomadic_authority_3
		}
		trigger_else_if = {
			limit = {
				has_government = tribal_government
			}
			OR = {
				has_realm_law = tribal_authority_2
			}
		}
		OR = {
			religion = religion:christianity_religion
			religion = religion:tengrism_religion
		}
		culture = {
			custom_tooltip = {
				text = altaic_or_mongolic_tt
				OR = {
					has_cultural_parameter = heritage_group_altaic
					has_cultural_parameter = heritage_group_mongolic
				}
			}
		}
	}

	is_valid_showing_failures_only = {
		is_adult = yes
		is_available = yes
		is_independent_ruler = yes
	}

	cost = {
		gold = {
			value = massive_gold_value
		}
		prestige = {
			value = major_prestige_value
		}
	}

	effect = {
		#Can only happen once
		add_to_global_variable_list = {
			name = unavailable_unique_decisions
			target = flag:restore_avar_khaganate_decision
		}

		save_scope_as = avar_khan

		show_as_tooltip = {
			restore_avar_khaganate_effect = yes
		}
		# trigger_event = central_asia.0011

		add_to_list = notification_sent
	}
}

### Commission Castelli Craftsman
# Heavily based on commission_artifact_decision
# You hire a skilled Castelli craftsman to make you something nice
commission_castelli_craftsman = {
	picture = "gfx/interface/illustrations/decisions/decision_smith.dds"
	
	cooldown = { days = standard_commission_artifact_cooldown_time }
	sort_order = 100
	
	is_shown = {
		is_landed = yes
		highest_held_title_tier >= tier_county
		exists = capital_province
		capital_province = {
			geographical_region = custom_carpathia
		}
		# If you wipe out the Latin Pannonians, then you can't commission them!
	}
	
	is_valid_showing_failures_only = {
		# Only valid for characters with an antiquarian.
		employs_court_position = antiquarian_court_position
		custom_tooltip = {
			text = castelli_still_exist_tt
			any_county_in_region = {
				region = custom_carpathia
				OR = {
					county_has_specific_minority_culture_trigger = { CULTURE = culture:keszthely }
					culture = culture:keszthely
				}
			}
		}
	}

	minimum_cost = {
		gold = basic_fund_inspiration_cost
	}

    widget = {
    	gui = "decision_view_widget_commission_artifact"
		controller = decision_option_list_controller
    	
		decision_has_second_step = yes
		decision_custom_widget_container = "custom_widgets_container_step_two"
		decision_to_second_step_button = "COMMISSION_ARTIFACT_DECISION_NEXT_STEP_BUTTON" 


		# Personal Artifacts are always valid to commission
		item = {
			value = commission_weapon
			current_description = {
				desc = commission_artifact_decision_option_weapon_desc
			}
			localization  = {
				desc = commission_artifact_decision_option_weapon
			}
			icon = "gfx/interface/icons/artifact/artifact_sword.dds"

			ai_chance = {
				value = 0 
				if = {
					limit = {
						# Only make this choice if we don't already have an artifact of this type.
						NOT = {
							any_character_artifact = {
								artifact_slot_type = primary_armament
							}
						}
					}
					add = 100
				}
			}
		}

		item = {
			value = commission_armor
			current_description = {
				desc = commission_artifact_decision_option_armor_desc
			}
			localization = {
				desc = commission_artifact_decision_option_armor
			}
			icon = "gfx/interface/icons/artifact/artifact_armor.dds"

			ai_chance = {
				value = 0 
				if = {
					limit = {
						# Only make this choice if we don't already have an artifact of this type.
						NOT = {
							any_character_artifact = {
								artifact_slot_type = armor
							}
						}
					}
					add = 100
				}
			}
		}

		item = {
			value = commission_crown
			current_description = {
				desc = commission_artifact_decision_option_crown_desc
			}
			localization = {
				desc = commission_artifact_decision_option_crown
			}
			icon = "gfx/interface/icons/artifact/artifact_crown.dds"

			ai_chance = {
				value = 0 
				if = {
					limit = {
						# Only make this choice if we don't already have an artifact of this type.
						NOT = {
							any_character_artifact = {
								artifact_slot_type = helmet
							}
						}
					}
					add = 100
				}
			}
		}

		item = {
			value = commission_regalia
			current_description = {
				desc = commission_artifact_decision_option_regalia_desc
			}
			localization = {
				desc = commission_artifact_decision_option_regalia
			}
			icon = "gfx/interface/icons/artifact/artifact_regalia.dds"

			ai_chance = {
				value = 0 
				if = {
					limit = {
						# Only make this choice if we don't already have an artifact of this type.
						NOT = {
							any_character_artifact = {
								artifact_slot_type = regalia
							}
						}
					}
					add = 100
				}
			}
		}

		# Court Artifacts only appear if you have the Royal Court DLC, and are only valid if you have an active Royal Court
		
		item = {
			value = commission_tapestry
			is_shown = { has_dlc_feature = royal_court }
			is_valid = { has_royal_court = yes }
			current_description = {
				desc = commission_artifact_decision_option_tapestry_desc
			}

			localization = {
				desc = commission_artifact_decision_option_tapestry
			}
			icon = "gfx/interface/icons/artifact/artifact_tapestry.dds"

			ai_chance = {
				value = 0 
				if = {
					limit = {
						has_royal_court = yes
						# Only make this choice if we don't already have an artifact of this type.
						NOR = {
							any_character_artifact = {
								artifact_slot_type = wall_big
							}
							any_character_artifact = {
								artifact_slot_type = wall_small
							}
						}
					}
					add = 100
				}
			}
		}

		item = {
			value = commission_furniture
			is_shown = { has_dlc_feature = royal_court  }
			is_valid = { has_royal_court = yes }
			current_description = {
				desc = commission_artifact_decision_option_furniture_desc
			}
			localization = {
				desc = commission_artifact_decision_option_furniture
			}
			icon = "gfx/interface/icons/artifact/artifact_cabinet.dds"

			ai_chance = {
				value = 0 
				if = {
					limit = {
						has_royal_court = yes
						# Only make this choice if we don't already have an artifact of this type.
						NOT = {
							any_character_artifact = {
								artifact_slot_type = sculpture
							}
						}
					}
					add = 100
				}
			}
		}

		item = {
			value = commission_book
			is_shown = { has_dlc_feature = royal_court  }
			is_valid = { has_royal_court = yes }
			current_description = {
				desc = commission_artifact_decision_option_book_desc
			}
			localization = {
				desc = commission_artifact_decision_option_book
			}
			icon = "gfx/interface/icons/artifact/artifact_book.dds"

			ai_chance = {
				value = 0 
				if = {
					limit = {
						has_royal_court = yes
						# Only make this choice if we don't already have an artifact of this type.
						NOT = {
							any_character_artifact = {
								artifact_slot_type = book
							}
						}
					}
					add = 100
				}
			}
		}

		#Alchemy isn't included here since that inspiration is much more tied to the pursuit of knowledge initiated by the inspired person
	}

	effect = {
		if = {
			limit = {
				any_court_position_holder = {
					type = antiquarian_court_position
				}
			}
			random_court_position_holder = {
				type = antiquarian_court_position
				save_scope_as = antiquarian
			}
		}
		# Explanatory Tooltips
		custom_tooltip = commission_castelli_craftsman_effect
		# Artisan Generation
		hidden_effect = {
			create_character = {
				template = local_castelli_artisan_template
				location = root.capital_province
				gender_female_chance = root_faith_dominant_gender_adjusted_female_chance
				save_scope_as = local_artisan
			}
			scope:local_artisan = {
				hidden_effect = {
					add_character_modifier = local_artisan_modifier
				}
			}
		}

		hidden_effect = {
			if = {
				# Conditional exists to avoid false-positives during tooltip generation, but 'local_artisan' should always exist on execution!
				limit = { exists = scope:local_artisan }
				root = { add_courtier = scope:local_artisan	}
				scope:local_artisan = {
					add_character_flag = local_artisan
					if = {
						limit = { scope:commission_weapon = yes }
						create_inspiration = weapon_inspiration
					}
					else_if = {
						limit = { scope:commission_armor = yes }
						set_variable = {
							name = force_armor
							value = flag:force_armor_true
						}
						create_inspiration = armor_inspiration
					}
					else_if = {
						limit = { scope:commission_crown = yes }
						set_variable = {
							name = artifact_smith_type
							value = flag:smith_type_crown
						}
						create_inspiration = smith_inspiration
					}
					else_if = {
						limit = { scope:commission_regalia = yes }
						set_variable = {
							name = artifact_smith_type
							value = flag:smith_type_regalia
						}
						create_inspiration = smith_inspiration
					}
					else_if = {
						limit = { scope:commission_tapestry = yes }
						root = {
							trigger_event = fund_inspiration.0044
						}
					}
					else_if = {
						limit = { scope:commission_furniture = yes }
						create_inspiration = artisan_inspiration
					}
					else_if = {
						limit = { scope:commission_book = yes }
						create_inspiration = book_inspiration
					}
					if = {
						limit = { exists = inspiration }
						inspiration = { save_scope_as = this_inspiration }
						root = { sponsor_inspiration = scope:this_inspiration }
					}
				}
			}
		}

		add_prestige = minor_prestige_gain

		culture = {
			change_cultural_acceptance = {
				target = culture:keszthely
				value = {
					value = root.highest_held_title_tier
					subtract = 1
				}
			}
		}

	}
}