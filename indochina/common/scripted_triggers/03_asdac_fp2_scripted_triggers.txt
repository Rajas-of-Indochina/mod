
##################################################
# General Triggers

asdac_character_any_involvement_asdac_byzantine_struggle_trigger = {
	has_fp2_dlc_trigger = yes
	OR = {
		asdac_character_involved_in_struggle_trigger = yes
		asdac_character_interloper_in_struggle_trigger = yes
	}
}

asdac_character_involved_in_struggle_trigger = {
	has_fp2_dlc_trigger = yes
	any_character_struggle = {
		involvement = involved
		is_struggle_type = asdac_byzantine_struggle
	}
}

asdac_character_interloper_in_struggle_trigger = {
	has_fp2_dlc_trigger = yes
	any_character_struggle = {
		involvement = interloper
		is_struggle_type = asdac_byzantine_struggle
	}
}

asdac_character_uninvolved_in_struggle_trigger = {
	has_fp2_dlc_trigger = yes
	exists = struggle:asdac_byzantine_struggle
	asdac_character_interloper_in_struggle_trigger = no
	asdac_character_involved_in_struggle_trigger = no
}

##################################################
# Illustration Triggers



##################################################
# Interaction Triggers

asdac_struggle_contract_assistance_war_winning_trigger = {
	trigger_if = {
		limit = {
			scope:recipient = { is_attacker_in_war = prev }
		}
		attacker_war_score >= offer_assistance_interaction_already_winning_value
	}
	trigger_else = { defender_war_score >= offer_assistance_interaction_already_winning_value }
}

asdac_struggle_contract_assistance_war_losing_trigger = {
	trigger_if = {
		limit = {
			scope:recipient = { is_attacker_in_war = prev }
		}
		defender_war_score >= offer_assistance_interaction_already_losing_value
	}
	trigger_else = { attacker_war_score >= offer_assistance_interaction_already_losing_value }
}

asdac_struggle_contract_assistance_war_outnumbering_trigger = {
 	trigger_if = {
		limit = {
			scope:recipient = { is_attacker_in_war = prev }
		}
		war_attacker_total_strength_halved_value > war_defender_total_strength_value
	}
	trigger_else = { war_defender_total_strength_halved_value > war_attacker_total_strength_value }
 }

asdac_struggle_contract_assistance_war_outnumbered_trigger = {
 	trigger_if = {
		limit = {
			scope:recipient = { is_attacker_in_war = prev }
		}
		war_defender_total_strength_halved_value > war_attacker_total_strength_value
	}
	trigger_else = { war_attacker_total_strength_halved_value > war_defender_total_strength_value }
}

asdac_struggle_contract_assistance_war_outnumbered_minor_trigger = {
 	trigger_if = {
		limit = {
			scope:recipient = { is_attacker_in_war = prev }
		}
		war_defender_total_strength_value > war_attacker_total_strength_value
	}
	trigger_else = { war_attacker_total_strength_value > war_defender_total_strength_value }
}

asdac_struggle_contract_assistance_war_insufficient_trigger = {
	trigger_if = {
		limit = {
			scope:recipient = { is_attacker_in_war = prev }
		}
		scope:actor.max_military_strength < war_defender_total_strength_divided_value
	}
	trigger_else = { scope:actor.max_military_strength < war_attacker_total_strength_divided_value }
}

##################################################
# Religious Triggers



##################################################
# Achievement Triggers

##################################################
# Decision Triggers

##### Struggle Ending #####

### Common

# Checks a de jure kingdom of Hispania is completely controlled
asdac_struggle_ending_hold_de_jure_kingdom_trigger = {
	any_held_title = {
		tier = tier_kingdom
		de_jure_liege = title:e_byzantium
		save_temporary_scope_as = byzantine_kingdom
	}
	trigger_if = {
		limit = { exists = scope:byzantine_kingdom }
		completely_controls = scope:byzantine_kingdom
	}
	trigger_else = { always = no }
}

# Checks less than half of Iberia owned
asdac_struggle_ending_percent_iberia_trigger = {
	any_county_in_region = {
		region = asdac_byzantine_struggle_region
		percent < fp2_struggle_compromise_owned_percent_decimal_value
		holder.top_liege = root
	}
}

# Checks no more than half of Iberia is owned by another
asdac_struggle_ending_other_percent_iberia_trigger = {
	struggle:asdac_byzantine_struggle = {
		NOT = {
			any_involved_ruler = {
				exists = primary_title # Max figured out that is_independent_ruler causes errors if you are unlanded
				NOT = { this = root }
				is_independent_ruler = yes
				primary_title = { is_mercenary_company = no }
				any_county_in_region = {
					region = asdac_byzantine_struggle_region
					percent > fp2_struggle_compromise_involved_percent_decimal_value
					holder.top_liege = prev
				}
			}
		}
	}
}

# Checks duchy is held by an independent ruler who owns at least half of it
asdac_struggle_ending_compromise_independent_duchy_trigger = {
	tier = tier_duchy
	# Is created
	exists = holder
	# Is not the heartland of an existing kingdom
	NOT = { title_capital_county = de_jure_liege.title_capital_county }
	# Is ruled by an independent duke
	holder = {
		is_independent_ruler = yes
		primary_title = {
			is_mercenary_company = no
			tier = tier_duchy
		}
		save_temporary_scope_as = duchy_holder
	}
	# Duke rules at least half the de jure duchy
	any_direct_de_jure_vassal_title = {
		percent >= 0.5
		holder.top_liege = scope:duchy_holder
	}
}

# Checks duchy should be split from de jure kingdom
asdac_struggle_ending_compromise_split_duchy_trigger = {
	tier = tier_duchy
	# Has not been tampered with already
	NOT = { is_in_list = duchy_kingdom }
	# Is not created
	NOT = { exists = holder }
	# Is not heartland of an existing kingdom
	NOT = { title_capital_county = de_jure_liege.title_capital_county }
	save_temporary_scope_as = duchy
	# Less than half is owned by de jure kingdom, if created
	trigger_if = {
		limit = { exists = scope:duchy.de_jure_liege.holder }
		any_direct_de_jure_vassal_title = {
			percent < 0.5
			holder.top_liege = scope:duchy.de_jure_liege.holder
		}
	}
}

# Checks titular duchy should be made into de jure kingdom
asdac_struggle_ending_compromise_titular_trigger = {
	# Has not been tampered with already
	NOT = { is_in_list = duchy_kingdom }
	# Is created
	exists = holder
	# Is ruled by an independent duke
	holder = {
		is_independent_ruler = yes
		primary_title = {
			is_mercenary_company = no
			tier = tier_duchy
		}
	}
	# Titular duke holds at least half of any de jure duchy of Hispania
	title:e_byzantium = {
		any_in_de_jure_hierarchy = {
			tier = tier_duchy
			any_direct_de_jure_vassal_title = {
				percent >= 0.5
				holder.top_liege = scope:special_duchy.holder
			}
		}
	}
}

# Checks two cultures were Involved in the struggle that ended in Conciliation
#asdac_struggle_conciliation_special_cultural_rules_trigger = {
#	has_global_variable = asdac_struggle_conciliation_ending
#	any_in_global_list = {
#		variable = asdac_struggle_ending_culture_list
#		this = $C1$.culture
#	}
#	any_in_global_list = {
#		variable = asdac_struggle_ending_culture_list
#		this = $C2$.culture
#	}
#}

# Checks two faiths were Involved in the struggle that ended in Conciliation
#are_holy_wars_disabled_by_struggle_conciliation_trigger = {
#	has_global_variable = asdac_struggle_conciliation_ending
#	any_in_global_list = {
#		variable = asdac_struggle_ending_faith_list
#		this = scope:attacker.faith
#	}
#	any_in_global_list = {
#		variable = asdac_struggle_ending_faith_list
#		this = scope:defender.faith
#	}
#}

# Checks if characters were both involved in struggle
#asdac_struggle_conciliation_recipient_actor_involved_trigger = {
#	has_global_variable = asdac_struggle_conciliation_ending
#	AND = {
#		scope:actor.capital_province = { geographical_region = asdac_byzantine_struggle_region }
#		scope:recipient.capital_province = { geographical_region = asdac_byzantine_struggle_region }
		# Offer comes from an Involved culture/faith character
#		OR = {
#			any_in_global_list = {
#				variable = asdac_struggle_ending_faith_list
#				this = scope:actor.faith
#			}
#			any_in_global_list = {
#				variable = asdac_struggle_ending_culture_list
#				this = scope:actor.culture
#			}
#		}
#		# Recipient is from an Involved culture/faith
#		OR = {
#			any_in_global_list = {
#				variable = asdac_struggle_ending_faith_list
#				this = scope:recipient.faith
#			}
#			any_in_global_list = {
#				variable = asdac_struggle_ending_culture_list
#				this = scope:recipient.culture
#			}
#		}
#	}
#}

# Checks if character was involved in struggle
#asdac_struggle_conciliation_scope_uninvolved_trigger = {
#	has_global_variable = asdac_struggle_conciliation_ending
#	OR = {
#		NOR = {
#			any_in_global_list = {
#				variable = asdac_struggle_ending_faith_list
#				this = $SCOPE$.faith
#			}
#			any_in_global_list = {
#				variable = asdac_struggle_ending_culture_list
#				this = $SCOPE$.culture
#			}
#		}
#		NOT = {
#			$SCOPE$.capital_province = { geographical_region = asdac_byzantine_struggle_region }
#		}
#	}
#}

asdac_struggle_any_realm_county_in_byzantium_trigger = {
	any_realm_county = { target_is_de_jure_liege_or_above = title:e_byzantium }
}

asdac_struggle_enforce_truce_war_leader_trigger = {
	custom_tooltip = {
		text = fp2_enforce_truce_war_with_not_involved_tt
		any_character_struggle = {
			involvement = involved
		}
	}
	custom_tooltip = {
		text = fp2_enforce_truce_tier_difference_tt
		tier_difference = {
			target = scope:actor
			value <= 0
		}
	}
	NOR = {
		this = scope:recipient
		this = scope:actor
	}
	custom_tooltip = {
		text = fp2_enforce_truce_liege_or_independent_tt
		OR = {
			scope:recipient = { is_independent_ruler = yes }
			scope:recipient.top_liege = scope:actor.top_liege
			is_independent_ruler = yes
			top_liege = scope:actor.top_liege
		}
	}
}
