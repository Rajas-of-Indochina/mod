restore_avar_khaganate_effect = {
	if = {
		# Create Carpathia if it doesn't exist. It will become Avaria
		limit = {
			title:e_carpathia = { is_title_created = no }
		}
		create_title_and_vassal_change = {
			type = created
			save_scope_as = change
		}
		title:e_carpathia = {
			change_title_holder = {
				holder = root
				change = scope:change
			}
		}
		resolve_title_and_vassal_change = scope:change
	}
	title:e_carpathia = { set_title_name = e_avaria }
	title:k_pannonia = { set_title_name = KINGDOM_PANNONIA }
	# Resolve de jure:
	# Moravia only moves de jure if it actually exists (so before 1066 start)
	if = {
		limit = {
			title:k_moravia = { is_titular = no }
		}
		title:k_moravia = {
			set_de_jure_liege_title = title:e_carpathia
		}
	}

	# But Bohemia moves regardless
	title:k_bohemia = {
		set_de_jure_liege_title = title:e_carpathia
	}

	# Sort out Slavonia and Croatia
	if = {
		# If your rule over Croatia is uncontested then it ALL becomes yours de jure
		limit = {
			completely_controls = title:k_croatia
		}
		title:k_croatia = {
			set_de_jure_liege_title = title:e_carpathia
		}
	}
	else = {
		# Otherwise just move Slavonia to Hungary.
		title:d_slavonia = {
			set_de_jure_liege_title = title:k_hungary
		}
	}

	# Sort out Syrmia and Serbia
	if = {
		# If your rule over Croatia is uncontested then it ALL becomes yours de jure
		limit = {
			completely_controls = title:k_serbia
		}
		title:k_serbia = {
			set_de_jure_liege_title = title:e_carpathia
		}
	}
	else = {
		# Otherwise just move Slavonia to Hungary.
		title:d_syrmia = {
			set_de_jure_liege_title = title:k_hungary
		}
	}
	if = {
		limit = {
			completely_controls = title:k_bavaria
		}
		title:k_bavaria = {
			set_de_jure_liege_title = title:e_carpathia
			set_title_name = k_carantania
			set_coa = d_carinthia
		}
	}
	else_if = {
		limit = { completely_controls_region = custom_avar_carantania }
		custom_tooltip = {
			text = carantania_tt
			title:k_austria = {
				set_de_jure_liege_title = title:e_carpathia
				set_title_name = k_carantania
				set_coa = d_carinthia
				title:d_krain = { set_de_jure_liege_title = PREV }
				title:d_carinthia = { set_de_jure_liege_title = PREV }
				title:d_steyermark = { set_de_jure_liege_title = PREV }
				title:d_osterreich = { set_de_jure_liege_title = PREV }
			}
			title:d_istria = {
				set_de_jure_liege_title = title:k_italy
			}
		}
	}
	else = {
		custom_tooltip = avar_carantania_dummy_tt
	}
	if = {
		limit = { completely_controls = title:k_pontic_steppe }
		title:k_pontic_steppe = { set_de_jure_liege_title = title:e_carpathia }
	}
	else = {
		custom_tooltip = pontic_steppe_tt
	}
}