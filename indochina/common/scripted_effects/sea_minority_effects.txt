# Override Vanilla
# Allows hybridizing/diverging to work more smoothly with minorities
expand_hybrid_culture_from_origin_point = {
	every_title_to_title_neighboring_and_across_water_county = {
		limit = {
			holder.top_liege = $CONVERTEE$.top_liege
			save_temporary_scope_as = county_check
			$CULTURE$ = {
				any_parent_culture = {
					this = scope:county_check.culture
				}
			}
		}

		random = {
			chance = {
				value = 30
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 45 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 50 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 55 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 60 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 65 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 70 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 75 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 80 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 85 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 90 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 95 }
							}
						}
					}
					add = 5
				}
				if = {
					limit = {
						$CULTURE$ = {
							any_parent_culture = {
								save_temporary_scope_as = first_parent
							}
							any_parent_culture = {
								NOT = {
									this = scope:first_parent
								}
								cultural_acceptance = { target = scope:first_parent value >= 100 }
							}
						}
					}
					add = 5
				}
			}
			save_scope_as = county
			culture = {save_scope_as = old_culture}
			set_county_culture = $CULTURE$
			add_culture_minority_effect = {
				CULTURE = scope:old_culture
				COUNTY = scope:county
				SIZE = large
			}
			every_title_to_title_neighboring_and_across_water_county = {
				limit = {
					holder.top_liege = $CONVERTEE$.top_liege
					save_temporary_scope_as = county_check
					$CULTURE$ = {
						any_parent_culture = {
							this = scope:county_check.culture
						}
					}
				}
				random = {
					chance = {
						value = 30
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 45 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 50 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 55 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 60 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 65 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 70 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 75 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 80 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 85 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 90 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 95 }
									}
								}
							}
							add = 5
						}
						if = {
							limit = {
								$CULTURE$ = {
									any_parent_culture = {
										save_temporary_scope_as = first_parent
									}
									any_parent_culture = {
										NOT = {
											this = scope:first_parent
										}
										cultural_acceptance = { target = scope:first_parent value >= 100 }
									}
								}
							}
							add = 5
						}
					}
					save_scope_as = county
					culture = {save_scope_as = old_culture}
					set_county_culture = $CULTURE$
					add_culture_minority_effect = {
						CULTURE = scope:old_culture
						COUNTY = scope:county
						SIZE = large
					}
				}
			}
		}
	}
}

new_culture_created_conversion_effect = {

	# Save the hybrid culture for use with ai_will_do down the line
	if = {
		limit = {
			$CULTURE$ = { is_hybrid_culture = yes }
		}
		add_to_global_variable_list = { name = hybrid_cultures target = $CULTURE$ }
	}

	# Convert Counties (if of same culture as recipient's old culture)
	$CONVERTEE$ = {
		if = {
			limit = {
				capital_county = {
					save_temporary_scope_as = county_check
					$CULTURE$ = {
						any_parent_culture = {
							this = scope:county_check.culture
						}
					}
				}
			}
			capital_county = {
				save_scope_as = county
				culture = {save_scope_as = old_culture}
				set_county_culture = $CULTURE$
				add_culture_minority_effect = {
					CULTURE = scope:old_culture
					COUNTY = scope:county
					SIZE = large
				}
				expand_hybrid_culture_from_origin_point = {
					CONVERTEE = $CONVERTEE$
					CULTURE = $CULTURE$
				}
			}
		}
		else_if = {
			limit = {
				any_held_title = {
					tier = tier_county
					save_temporary_scope_as = county_check
					$CULTURE$ = {
						any_parent_culture = {
							this = scope:county_check.culture
						}
					}
				}
			}
			random_held_title = {
				limit = {
					tier = tier_county
					save_temporary_scope_as = county_check
					$CULTURE$ = {
						any_parent_culture = {
							this = scope:county_check.culture
						}
					}
				}
				save_scope_as = county
				culture = {save_scope_as = old_culture}
				set_county_culture = $CULTURE$
				add_culture_minority_effect = {
					CULTURE = scope:old_culture
					COUNTY = scope:county
					SIZE = large
				}
				expand_hybrid_culture_from_origin_point = {
					CONVERTEE = $CONVERTEE$
					CULTURE = $CULTURE$
				}
			}
		}
		else_if = {
			limit = {
				any_sub_realm_county = {
					save_temporary_scope_as = county_check
					$CULTURE$ = {
						any_parent_culture = {
							this = scope:county_check.culture
						}
					}
				}
			}
			random_sub_realm_county = {
				limit = {
					save_temporary_scope_as = county_check
					$CULTURE$ = {
						any_parent_culture = {
							this = scope:county_check.culture
						}
					}
				}
				save_scope_as = county
				culture = {save_scope_as = old_culture}
				set_county_culture = $CULTURE$
				add_culture_minority_effect = {
					CULTURE = scope:old_culture
					COUNTY = scope:county
					SIZE = large
				}
				expand_hybrid_culture_from_origin_point = {
					CONVERTEE = $CONVERTEE$
					CULTURE = $CULTURE$
				}
			}
		}
	}
	# Spouses convert
	$CONVERTEE$ = {
		every_spouse = {
			limit = {
				OR = {
					is_courtier_of = $CONVERTER$
					is_courtier_of = $CONVERTEE$
					is_vassal_of = $CONVERTER$
					is_vassal_of = $CONVERTEE$
				}
				save_temporary_scope_as = spouse_check
				$CULTURE$ = {
					any_parent_culture = {
						this = scope:spouse_check.culture
					}
				}
			}
			set_culture = $CULTURE$
			hidden_effect = {
				add_character_flag = converted_culture_this_lifetime
			}
		}
	}
	# Family in recipient's court also convert
	if = {
		limit = {
			$CONVERTEE$ = {
				is_ruler = yes
				any_close_or_extended_family_member = {
					exists = court_owner
					court_owner = $CONVERTEE$
					NOT = { culture = $CULTURE$ }
					is_ai = yes
				}
			}
		}
		$CONVERTEE$ = {
			every_close_or_extended_family_member = {
				custom = all_family_members_at_court
				limit = {
					exists = court_owner
					court_owner = $CONVERTEE$
					NOT = { culture = $CULTURE$ }
					is_ai = yes
					save_temporary_scope_as = family_check
					$CULTURE$ = {
						any_parent_culture = {
							this = scope:family_check.culture
						}
					}
				}
				set_culture = $CULTURE$
				hidden_effect = {
					add_character_flag = converted_culture_this_lifetime
				}
			}
		}
	}
	# Make sure relevant non-significant characters convert
	$CONVERTEE$ = {
		hidden_effect = {
			every_courtier_or_guest = {
				limit = {
					NOT = { culture = $CULTURE$ }
					is_ai = yes
					has_no_particular_noble_roots_trigger = yes
					save_temporary_scope_as = family_check
					$CULTURE$ = {
						any_parent_culture = {
							this = scope:family_check.culture
						}
					}
				}
				set_culture = $CULTURE$
				hidden_effect = {
					add_character_flag = converted_culture_this_lifetime
				}
			}
			if = {
				limit = {
					exists = $CONVERTEE$.capital_province
				}
				every_pool_character = {
					province = $CONVERTEE$.capital_province
					limit = {
						NOT = { culture = $CULTURE$ }
						is_ai = yes
						has_no_particular_noble_roots_trigger = yes
						save_temporary_scope_as = family_check
						$CULTURE$ = {
							any_parent_culture = {
								this = scope:family_check.culture
							}
						}
					}
					set_culture = $CULTURE$
					hidden_effect = {
						add_character_flag = converted_culture_this_lifetime
					}
				}
			}
		}
	}
	$CONVERTEE$ = { # Clean up culture in the realm for subvassals with a liege of the wrong culture
		hidden_effect = {
			every_vassal_or_below = {
				limit = {
					is_landed = yes
					save_temporary_scope_as = vassal_check
					$CULTURE$ = {
						any_parent_culture = {
							this = scope:vassal_check.culture
						}
					}
					NOT = {
						$CULTURE$ = {
							any_parent_culture = {
								this = scope:vassal_check.liege.culture
							}
						}
					}
				}
				save_scope_as = vassal_converting
				new_culture_created_vassal_conversion_effect = {
					CONVERTEE = scope:vassal_converting
					CONVERTER = $CONVERTER$
					CULTURE = $CULTURE$
				}
			}
			#every_sub_realm_county = {
			#	limit = {
			#		save_temporary_scope_as = county_check
			#		$CULTURE$ = {
			#			any_parent_culture = {
			#				this = scope:county_check.culture
			#			}
			#		}
			#		NOT = {
			#			$CULTURE$ = {
			#				any_parent_culture = {
			#					this = scope:county_check.holder.culture
			#				}
			#			}
			#		}
			#	}
			#	set_county_culture = $CULTURE$
			#}
		}
	}
	$CONVERTEE$ = {
		set_culture = $CULTURE$
		hidden_effect = {
			add_character_flag = converted_culture_this_lifetime
		}
	}
}

# Embrace English Culture override
embrace_english_culture_effect = {
	# Scopes saves for localization
	root = {
		save_scope_as = embracer
	}

	culture = {save_scope_as = french_culture}

	# Prestige Bonus
	add_prestige = medium_prestige_gain

	#Convert your, and your whole family's, culture
	set_culture = culture:english
	if = {
		limit = { any_spouse = { is_landed = no } }
		every_spouse = {
			limit = {
				is_landed = no
				OR = {
					culture = { has_cultural_pillar = heritage_frankish }
				}
			}
			set_culture = culture:english
		}
	}
	if = {
		limit = {
			any_close_family_member = {
				is_landed = no
				NOT = { is_spouse_of = root }
			}
		}
		every_close_family_member = {
			limit = {
				is_landed = no
				NOT = { is_spouse_of = root }
			}
			custom = all_unlanded_family_members
			set_culture = culture:english
		}
	}
	if = {
		limit = {
			any_child = {
				NOT = { is_spouse_of = root }
			}
		}
		every_child = {
			limit = {
				NOT = { is_spouse_of = root }
			}
			custom = all_children_custom
			set_culture = culture:english
		}
	}

	#Convert appropriate vassals, and their family
	if = {
		limit = {
			any_vassal_or_below = {
				is_ai = yes
				OR = {
					culture = culture:norman
					culture = culture:french
				}
				primary_title = {
					OR = {
						de_jure_liege = title:k_england
						de_jure_liege.de_jure_liege = title:k_england
						de_jure_liege.de_jure_liege.de_jure_liege = title:k_england
					}
				}
			}
		}
		every_vassal_or_below = {
			custom = embrace_english_culture_vassals_custom
			limit = {
				is_ai = yes
				OR = {
					culture = culture:norman
					culture = culture:french
				}
				primary_title = {
					OR = {
						de_jure_liege = title:k_england
						de_jure_liege.de_jure_liege = title:k_england
						de_jure_liege.de_jure_liege.de_jure_liege = title:k_england
					}
				}
			}
			set_culture = culture:english
			hidden_effect = {
				if = {
					limit = { any_spouse = { is_landed = no } }
					every_spouse = {
						limit = {
							is_landed = no
							OR = {
								culture = culture:norman
								culture = culture:french
							}
						}
						set_culture = culture:english
					}
				}
				if = {
					limit = {
						any_close_family_member = {
							is_landed = no
							NOT = { is_spouse_of = prev }
						}
					}
					every_close_family_member = {
						limit = {
							is_landed = no
							NOT = { is_spouse_of = prev }
						}
						custom = all_unlanded_family_members
						set_culture = culture:english
					}
				}
				if = {
					limit = {
						any_child = {
							NOT = { is_spouse_of = prev }
						}
					}
					every_child = {
						limit = {
							NOT = { is_spouse_of = prev }
						}
						custom = all_children_custom
						set_culture = culture:english
					}
				}
				if = {
					limit = {
						any_vassal_or_below = {
							is_ai = yes
							OR = {
								culture = culture:norman
								culture = culture:french
							}
							primary_title = {
								OR = {
									de_jure_liege = title:k_england
									de_jure_liege.de_jure_liege = title:k_england
									de_jure_liege.de_jure_liege.de_jure_liege = title:k_england
								}
							}
						}
					}
					every_vassal_or_below = {
						custom = embrace_english_culture_vassals_custom
						limit = {
							is_ai = yes
							OR = {
								culture = culture:norman
								culture = culture:french
							}
							primary_title = {
								OR = {
									de_jure_liege = title:k_england
									de_jure_liege.de_jure_liege = title:k_england
									de_jure_liege.de_jure_liege.de_jure_liege = title:k_england
								}
							}
						}
						set_culture = culture:english
						hidden_effect = {
							if = {
								limit = { any_spouse = { is_landed = no } }
								every_spouse = {
									limit = {
										is_landed = no
										OR = {
											culture = culture:norman
											culture = culture:french
										}
									}
									set_culture = culture:english
								}
							}
							if = {
								limit = {
									any_close_family_member = {
										is_landed = no
										NOT = { is_spouse_of = prev }
									}
								}
								every_close_family_member = {
									limit = {
										is_landed = no
										NOT = { is_spouse_of = prev }
									}
									custom = all_unlanded_family_members
									set_culture = culture:english
								}
							}
							if = {
								limit = {
									any_child = {
										NOT = { is_spouse_of = prev }
									}
								}
								every_child = {
									limit = {
										NOT = { is_spouse_of = prev }
									}
									custom = all_children_custom
									set_culture = culture:english
								}
							}
						}
					}
				}
			}
		}
	}

	#Flip Counties
	every_county_in_region = {
		region = custom_england
		custom = embrace_english_culture_counties_custom
		limit = {
			target_is_de_facto_liege_or_above = root.primary_title
		}
		save_scope_as = county
		culture = { save_scope_as = old_culture }
		random_list = {
			40 = {
				set_county_culture = culture:english
				add_culture_minority_effect = {
					CULTURE = scope:old_culture
					COUNTY = scope:county
					SIZE = small
				}
				add_culture_minority_effect = {
					CULTURE = scope:french_culture
					COUNTY = scope:county
					SIZE = small
				}
			}
			40 = {
				add_culture_minority_effect = {
					CULTURE = culture:english
					COUNTY = scope:county
					SIZE = large
				}
			}
			20 = {
				add_culture_minority_effect = {
					CULTURE = culture:english
					COUNTY = scope:county
					SIZE = small
				}
			}
		}
	}

	culture:english = {
		custom_tooltip = decision_embrace_english_culture_get_innovations
		hidden_effect = {
			reset_culture_creation_date = yes
			get_all_innovations_from = culture:norman
			get_all_innovations_from = culture:anglo_saxon
		}
	}
}

###
convert_player_realm_from_old_culture_to_new_effect = {
	# For localization
	$OLD_CULTURE$ = { save_scope_as = old_culture }
	$NEW_CULTURE$ = { save_scope_as = new_culture }

	custom_tooltip = global_culture.custom.change_culture
	hidden_effect = {
		# Compile a list of everyone who will flip to the new culture.
		every_vassal_or_below = {
			limit = {
				culture = $OLD_CULTURE$
			}
			add_to_list = characters_to_convert
			every_courtier = {
				limit = {
					culture = $OLD_CULTURE$
				}
				add_to_list = characters_to_convert
			}
		}
		every_courtier = {
			limit = {
				culture = $OLD_CULTURE$
			}
			add_to_list = characters_to_convert
		}

		# Flip the player to the new culture.
		set_culture = $NEW_CULTURE$
		add_character_flag = converted_culture_this_lifetime

		# Flip their courtiers/vassals with a custom description.
		every_in_list = {
			list = characters_to_convert
			set_culture = $NEW_CULTURE$
		}

		# Then flip all their counties.
		every_sub_realm_county = {
			limit = {
				culture = $OLD_CULTURE$
			}
			set_county_culture = $NEW_CULTURE$
			save_scope_as = county
			add_culture_minority_effect = {
				CULTURE = $OLD_CULTURE$
				COUNTY = scope:county
				SIZE = large
			}
		}
	}
}

# $CULTURE$
# $SIZE$
# $COUNTY$
add_culture_minority_effect = {
	$COUNTY$ = {
		save_scope_as = loc_county # for loc
 		if = {
			limit = {
				NOR = {
					culture = $CULTURE$
					is_target_in_variable_list = { name = culture_minorities_small target = $CULTURE$  }
					is_target_in_variable_list = { name = culture_minorities_large target = $CULTURE$  }
				}
			}
			add_to_variable_list = {
				name = culture_minorities_$SIZE$
				target = $CULTURE$
			}
		}
	}
	$CULTURE$ = { save_scope_as = loc_culture }
	if = {
		limit = { is_target_in_variable_list = { name = culture_minorities_large target = $CULTURE$ } }
		custom_tooltip = add_culture_minority_effect_large_tt
	}
	else = {
		custom_tooltip = add_culture_minority_effect_small_tt
	}
}

# $FAITH$
# $SIZE$
# $COUNTY$
add_faith_minority_effect = {
	$COUNTY$ = {
		if = {
			limit = {
				NOR = {
					faith = $FAITH$
					is_target_in_variable_list = { name = faith_minorities_small target = $FAITH$  }
					is_target_in_variable_list = { name = faith_minorities_large target = $FAITH$  }
				}
			}

			add_to_variable_list = {
				name = faith_minorities_$SIZE$
				target = $FAITH$
			}
		}
	}
}

# scope:county
# $CULTURE$
promote_culture_minority_effect = {
	$CULTURE$ = { save_scope_as = minority_growth }
	custom_tooltip = minority_culture_growth
	if = {
		limit = { scope:county.culture = $CULTURE$ }
		# failsafe because this should never happen
	}
	else_if = {
		limit = {
			has_variable_list = culture_minorities_small
			is_target_in_variable_list = {
				name = culture_minorities_small
				target = $CULTURE$
			}
		}
		add_to_variable_list = {
			name = culture_minorities_large
			target = $CULTURE$
		}
		remove_list_variable = {
			name = culture_minorities_small
			target = $CULTURE$
		}
	}
	else_if = {
		limit = {
			has_variable_list = culture_minorities_large
			is_target_in_variable_list = {
				name = culture_minorities_large
				target = $CULTURE$
			}
		}
		remove_list_variable = {
			name = culture_minorities_large
			target = $CULTURE$
		}
		add_to_variable_list = {
			name = culture_minorities_large
			target = scope:county.culture
		}

		set_county_culture = $CULTURE$
	}
	else = {
		add_to_variable_list = {
			name = culture_minorities_small
			target = $CULTURE$
		}
	}
}

# scope:county
# $FAITH$
promote_faith_minority_effect = {
	$FAITH$ = { save_scope_as = minority_growth }
	custom_tooltip = minority_faith_growth
	if = {
		limit = { scope:county.faith = $FAITH$ }
		# failsafe because this should never happen
	}
	else_if = {
		limit = {
			has_variable_list = faith_minorities_small
			is_target_in_variable_list = {
				name = faith_minorities_small
				target = $FAITH$
			}
		}
		add_to_variable_list = {
			name = faith_minorities_large
			target = $FAITH$
		}
		remove_list_variable = {
			name = faith_minorities_small
			target = $FAITH$
		}
	}
	else_if = {
		limit = {
			has_variable_list = faith_minorities_large
			is_target_in_variable_list = {
				name = faith_minorities_large
				target = $FAITH$
			}
		}
		remove_list_variable = {
			name = faith_minorities_large
			target = $FAITH$
		}
		add_to_variable_list = {
			name = faith_minorities_large
			target = scope:county.faith
		}

		set_county_faith = $FAITH$
	}
	else = {
		add_to_variable_list = {
			name = faith_minorities_small
			target = $FAITH$
		}
	}
}

demote_random_faith_minority_effect = {
	if = {
		limit = { has_variable_list = faith_minorities_small }
		every_in_list = {
			variable = faith_minorities_small
			add_to_temporary_list = potential_faiths
		}
	}
	if = {
		limit = { has_variable_list = faith_minorities_large }
		every_in_list = {
			variable = faith_minorities_large
			add_to_temporary_list = potential_faiths
		}
	}

	random_in_list = {
		list = potential_faiths
		save_scope_as = faith_to_demote
	}

	if = {
		limit = { exists = scope:faith_to_demote }

		if = {
			limit = {
				has_variable_list = faith_minorities_large
				is_target_in_variable_list = {
					name = faith_minorities_large
					target = scope:faith_to_demote
				}
			}
			remove_list_variable = {
				name = faith_minorities_large
				target = scope:faith_to_demote
			}
			add_to_variable_list = {
				name = faith_minorities_small
				target = scope:faith_to_demote
			}
		}
		else_if = {
			limit = {
				has_variable_list = faith_minorities_small
				is_target_in_variable_list = {
					name = faith_minorities_small
					target = scope:faith_to_demote
				}
			}
			remove_list_variable = {
				name = faith_minorities_small
				target = scope:faith_to_demote
			}
		}
	}
}

demote_random_culture_minority_effect = {
	if = {
		limit = { has_variable_list = culture_minorities_small }
		every_in_list = {
			variable = culture_minorities_small
			add_to_temporary_list = potential_cultures
		}
	}
	if = {
		limit = { has_variable_list = culture_minorities_large }
		every_in_list = {
			variable = culture_minorities_large
			add_to_temporary_list = potential_cultures
		}
	}

	random_in_list = {
		list = potential_cultures
		save_scope_as = culture_to_demote
	}

	if = {
		limit = { exists = scope:culture_to_demote }

		if = {
			limit = {
				has_variable_list = culture_minorities_large
				is_target_in_variable_list = {
					name = culture_minorities_large
					target = scope:culture_to_demote
				}
			}
			remove_list_variable = {
				name = culture_minorities_large
				target = scope:culture_to_demote
			}
			add_to_variable_list = {
				name = culture_minorities_small
				target = scope:culture_to_demote
			}
		}
		else_if = {
			limit = {
				has_variable_list = culture_minorities_small
				is_target_in_variable_list = {
					name = culture_minorities_small
					target = scope:culture_to_demote
				}
			}
			remove_list_variable = {
				name = culture_minorities_small
				target = scope:culture_to_demote
			}
		}
	}
}

# scope:source_county
county_to_county_culture_faith_migration_effect = {
	scope:source_county = {
		if = {
			limit = {
				any_title_to_title_neighboring_county = {
					OR = {
						NOT = { faith = scope:source_county.faith }
						NOT = { culture = scope:source_county.culture }
					}
					holder = {
						has_realm_law_flag = religious_minorities_may_migrate
						has_realm_law_flag = cultural_minorities_may_migrate
					}
				}
			}
			random_neighboring_county = {
				limit = {
					OR = {
						NOT = { faith = scope:source_county.faith }
						NOT = { culture = scope:source_county.culture }
					}
					holder = {
						has_realm_law_flag = religious_minorities_may_migrate
						has_realm_law_flag = cultural_minorities_may_migrate
					}
				}
				save_scope_as = county
				if = {
					limit = { NOT = { faith = scope:source_county.faith } }
					promote_faith_minority_effect = { FAITH = scope:source_county.faith }
				}
				if = {
					limit = { NOT = { culture = scope:source_county.culture } }
					promote_culture_minority_effect = { CULTURE = scope:source_county.culture }
				}
				notify_characters_of_culture_faith_migration_effect = yes
			}
		}
	}
}

# scope:minority_culture
# scope:source_county
minority_culture_growth_effect = {
	scope:source_county = {
		if = {
			limit = { holder = { has_realm_law_flag = cultural_minorities_may_grow } }
			save_scope_as = county
			promote_culture_minority_effect = { CULTURE = scope:minority_culture }
		}
	}
}

minority_culture_spread_effect = {
	scope:source_county = {
		random_neighboring_county = {
			limit = {
				holder = { has_realm_law_flag = cultural_minorities_may_migrate }
				NOT = { culture = scope:minority_culture }
			}
			save_scope_as = county
			promote_culture_minority_effect = { CULTURE = scope:minority_culture }
			notify_characters_of_culture_migration_effect = yes
		}
	}
}

# scope:minority_faith
# scope:source_county
minority_faith_growth_effect = {
	scope:source_county = {
		if = {
			limit = { holder = { has_realm_law_flag = religious_minorities_may_grow } }
			save_scope_as = county
			promote_faith_minority_effect = { FAITH = scope:minority_faith }
		}
	}
}

minority_faith_spread_effect = {
	scope:source_county = {
		random_neighboring_county = {
			limit = {
				holder = { has_realm_law_flag = religious_minorities_may_migrate }
				NOT = { faith = scope:minority_faith }
			}
			save_scope_as = county
			promote_faith_minority_effect = { FAITH = scope:minority_faith }
			notify_characters_of_faith_migration_effect = yes
		}
	}
}

# scope:source_county
# scope:county
notify_characters_of_culture_faith_migration_effect = {
	scope:source_county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:source_county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_culture_faith_spread_title
			custom_tooltip = minority_culture_faith_spread_tt
			right_icon = scope:county
		}
	}
}

# scope:source_county
# scope:county
notify_characters_of_faith_migration_effect = {
	scope:source_county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:source_county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_faith_spread_title
			custom_tooltip = minority_faith_spread_tt
			right_icon = scope:county
		}
	}
}

# scope:source_county
# scope:county
notify_characters_of_culture_migration_effect = {
	scope:source_county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:source_county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_culture_spread_title
			custom_tooltip = minority_culture_spread_tt
			right_icon = scope:county
		}
	}
}

# scope:source_county
# scope:county
notify_recipient_of_culture_faith_migration_effect = {
	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_culture_faith_appearance_title
			custom_tooltip = minority_culture_faith_appearance_tt
			right_icon = scope:county
		}
	}
}

# scope:source_county
# scope:county
notify_recipient_of_faith_migration_effect = {
	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_faith_appearance_title
			custom_tooltip = minority_faith_appearance_tt
			right_icon = scope:county
		}
	}
}

# scope:source_county
# scope:county
notify_recipient_of_culture_migration_effect = {
	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_culture_appearance_title
			custom_tooltip = minority_culture_appearance_tt
			right_icon = scope:county
		}
	}
}
