
sell_prisoner_into_slavery_effect = {

	$PRISONER$ = {
		save_scope_as = victim
	}

	$JAILOR$ = {
		save_scope_as = jailor
		save_scope_as = imprisoner #Save this scope to show correct tyranny tooltip
	}

	show_as_tooltip = {
		$PRISONER$ = {
			custom_tooltip = SOLD_INTO_SLAVERY
		}
	}

	scope:jailor = {
		add_gold = 5

		if = {
			limit = { #Killing infidels is relaxing
				has_trait = zealous
				NOT = { scope:jailor.faith = scope:victim.faith }
			}
			stress_impact = {
				zealous = minor_stress_impact_loss
			}
		}
		if = {
			limit = {
				has_relation_rival = scope:victim
			}
			add_prestige = minor_prestige_gain
			if = {
				limit = {
					NOR = {
						has_trait = vengeful
						has_trait = forgiving
					}
				}
				add_stress = medium_stress_loss
			}
			else = {
				stress_impact = {
					vengeful = major_stress_impact_loss
					forgiving = 0 #No stress reduction
				}
			}
		}

		#Kinslaying
		add_kinslayer_trait_or_nothing_effect = { VICTIM = scope:victim }

		#Tyranny
		if = {
			limit = {
				exists = scope:victim.liege
				NOT = { scope:victim.liege = scope:victim }
			}
			scope:victim.liege = {
				add_opinion = {
					target = prev
					modifier = enslaved_my_countryman_modifier
				}
			}
		}
	}

	enslave_opinion_effect = { PRISONER = scope:victim JAILOR = scope:jailor }

	hidden_effect = {
		$PRISONER$ = {
			death = {
				death_reason = death_enslaved
				killer = $JAILOR$
			}
		}
	}
}

enslave_opinion_effect = {
	$PRISONER$ = {
		# Victim's family & spouse hates executioner
		every_close_family_member = {
			limit = { NOT = { this = $JAILOR$ } }
			add_to_temporary_list = victim_family_list
		}
		every_spouse = {
			limit = {
				NOR = {
					this = $JAILOR$
					is_in_list = victim_family_list
				}
			}
			add_to_temporary_list = victim_family_list
		}

		if = {
			limit = {
				any_in_list = {
					list = victim_family_list
					count > 0
				}
			}
			every_in_list = {
				list = victim_family_list
				custom = all_close_family_and_spouses
				add_opinion = {
					target = $JAILOR$
					modifier = enslaved_close_family_crime
				}
			}
		}

		# Victim's friends and lovers
		every_relation = {
			type = friend
			limit = {
				NOR = {
					this = $PRISONER$
					is_in_list = victim_family_list
				}
			}
			add_to_list = victim_close_relations_list
		}
		every_relation = {
			type = lover
			limit = {
				NOR = {
					this = $PRISONER$
					is_in_list = victim_family_list
					is_in_list = victim_close_relations_list
				}
			}
			add_to_list = victim_close_relations_list
		}
		if = {
			limit = {
				any_in_list = {
					list = victim_close_relations_list
					always = yes
				}
			}
			every_in_list = {
				list = victim_close_relations_list
				custom = all_friends_and_lovers
				add_opinion = {
					target = $JAILOR$
					modifier = enslaved_close_relation_opinion
				}
			}
		}
	}
}

revoke_title_interaction_effect = {
	if = {
		limit = {
			scope:recipient = {
				faith = scope:actor.faith
				has_government = theocracy_government
			}
		}
		scope:actor = {
			add_piety = major_piety_loss
		}
		if = {
			limit = {
				exists = scope:actor.faith.religious_head
			}
			scope:actor.faith.religious_head = {
				add_opinion = {
					target = scope:actor
					modifier = impious_opinion
					opinion = -20
				}
			}
		}
	}
	if = {
		limit = {
			exists = scope:actor.faith.religious_head
			scope:recipient = scope:actor.faith.religious_head
		}
		scope:actor = {
			add_piety_level = -2
		}
	}
	if = {
		limit = {
			scope:landed_title.tier >= tier_barony
		}
		scope:actor = {
			revocation_tyranny_effect = yes
			title_revocation_stress_effect = yes
			consume_revoke_title_reason = scope:recipient
		}
		scope:recipient = {
			add_pressed_claim = scope:landed_title
			if = {
				limit = {
					is_a_faction_member = yes
				}
				add_joined_faction_discontent = 25
			}
		}

		if = {
			limit = { scope:landed_title.tier = tier_county }
			scope:landed_title = {
				change_county_control = {
					value = -30
					if = {
						limit = {
							NOT = { scope:recipient.culture = scope:actor.culture }
							scope:recipient.culture = this.culture
						}
						multiply = 1.5
					}
					if = {
						limit = {
							NOT = { scope:recipient.faith = scope:actor.faith }
							scope:recipient.faith = this.faith
						}
						multiply = 1.5
					}
				}
			}
		}
	}

	scope:actor = {
		if = {
			limit = { scope:hook = yes }
			use_hook = scope:recipient
		}
	}
	scope:recipient = {
		add_opinion = {
			target = scope:actor
			modifier = revoked_title
		}
		if = { #If they recently imprisoned you, or asked for your excommunication, they become your rival
			limit = {
				OR = {
					has_opinion_modifier = {
						target = scope:actor
						modifier = released_from_prison
					}
					AND = {
						exists = var:requested_my_excommunication
						var:requested_my_excommunication = scope:actor
					}
				}
				NOT = {
					has_relation_rival = scope:actor
				}
			}
			if = {
				limit = {
					has_relation_potential_rival = scope:actor
				}
				remove_relation_potential_rival = scope:actor
			}
			set_relation_rival = scope:actor
		}
		else = {
			progress_towards_rival_effect = {
				CHARACTER = scope:actor
				OPINION = no
			}
		}
	}

	# Penalty for taking the Party Baron's last title. I mean, come on...
	if = {
		limit = {
			scope:recipient = {
				has_character_flag = is_party_baron
				NOT = {
					any_held_title = {
						NOT = { this = scope:landed_title }
					}
				}
			}
		}
		scope:actor = {
			add_character_modifier = {
				modifier = party_baron_ended_the_party_modifier
				years = 10
			}
			random_owned_story = {
				limit = {
					story_type = story_party_baron
				}
				end_story = yes
			}
		}
	}
}

# execute_opinion_effect
headhunted_opinion_effect = {
	$VICTIM$ = {
		# Victim's family & spouse hates executioner
		every_close_family_member = {
			limit = { NOT = { this = $KILLER$ } }
			add_to_temporary_list = victim_family_list
		}
		every_spouse = {
			limit = {
				NOR = {
					this = $KILLER$
					is_in_list = victim_family_list
				}
			}
			add_to_temporary_list = victim_family_list
		}

		if = {
			limit = {
				any_in_list = {
					list = victim_family_list
					count > 0
				}
			}
			if = {
				limit = {
					$KILLER$ = {
						has_execute_reason = $VICTIM$
					}
				}
				every_in_list = {
					list = victim_family_list
					custom = all_close_family_and_spouses
					add_opinion = {
						target = $KILLER$
						modifier = headhunted_close_family
					}
				}
			}
			else = {
				every_in_list = {
					list = victim_family_list
					custom = all_close_family_and_spouses
					add_opinion = {
						target = $KILLER$
						modifier = headhunted_close_family_crime
					}
				}
			}
		}

		# Victim's dynasty hates executioner
		if = {
			limit = {
				exists = dynasty
				exists = $KILLER$.dynasty
				NOT = { dynasty = $KILLER$.dynasty }
				NOT = {
					$KILLER$ = {
						has_execute_reason = $VICTIM$
					}
				}
			}
			dynasty = {
				every_dynasty_member = {
					limit = {
						NOR = {
							this = $VICTIM$
							is_in_list = victim_family_list
						}
					}
					custom = all_dynasty_members
					add_to_temporary_list = victim_dynasty_list
					add_opinion = {
						target = $KILLER$
						modifier = headhunted_dynasty_member
					}
				}
			}
		}

		# Victim's friends and lovers
		every_relation = {
			type = friend
			limit = {
				NOR = {
					this = $VICTIM$
					is_in_list = victim_family_list
					is_in_list = victim_dynasty_list
				}
			}
			add_to_list = victim_close_relations_list
		}
		every_relation = {
			type = lover
			limit = {
				NOR = {
					this = $VICTIM$
					is_in_list = victim_family_list
					is_in_list = victim_dynasty_list
					is_in_list = victim_close_relations_list
				}
			}
			add_to_list = victim_close_relations_list
		}
		if = {
			limit = {
				any_in_list = {
					list = victim_close_relations_list
					always = yes
				}
			}
			every_in_list = {
				list = victim_close_relations_list
				custom = all_friends_and_lovers
				add_opinion = {
					target = $KILLER$
					modifier = headhunted_close_relation_opinion
				}
			}
		}
	}
}