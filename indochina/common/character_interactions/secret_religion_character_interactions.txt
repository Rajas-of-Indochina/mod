#secretly adopt faith
secret_religion_convert = {
	category = interaction_category_religion
	interface_priority = 150
	common_interaction = no

	is_shown = {
		scope:actor = {
			NOT = {
				has_faith = scope:recipient.faith
			}
			NOR = {
				any_secret = {
					secret_type = secret_religion
				}
				has_variable = forbid_crypto_reconversion
			}
		}
	}
	is_valid_showing_failures_only = {
		scope:actor = {
			NOT = {
				has_trait = honest
			}
			age >= 3
		}
	}
	on_accept = {
		scope:actor = {
			secret_religion_secretly_convert = {
				FAITH = scope:recipient.faith
			}
			add_piety = -500
		}
	}
	auto_accept = yes
}

#suggest secret conversion
secret_religion_demand_secret_conversion = {
	category = interaction_category_religion

	ai_maybe = yes
	ai_min_reply_days = 4
	ai_max_reply_days = 9
	can_send_despite_rejection = no
	ai_accept_negotiation = yes
	popup_on_receive = yes

	desc = secret_religion_demand_secret_conversion_desc

	is_shown = {
		scope:actor = {
			any_secret = {
				secret_type = secret_religion
			}
			NAND = {
				any_known_secret = {
					secret_type = secret_religion
					secret_owner = scope:recipient
				}
				scope:recipient.var:false_convert = scope:actor.var:false_convert
			}
			scope:recipient = {
				NOT = {
					has_faith = scope:actor.var:false_convert
				}
			}
		}
		scope:recipient = {
			is_ai = yes
		}
	}

	is_valid = {
		OR = {
			scope:actor = {
				#TODO: also allow if openly followed faith has Sanctioned False Conversion
				OR = {
					target_is_vassal_or_below = scope:recipient
					has_relation_lover = scope:recipient
					has_relation_soulmate = scope:recipient
					has_relation_friend = scope:recipient
					# This ought to be the superior phrasing,
					# but only has_relation_guardian has any localization at all
					#has_relation_ward = scope:recipient
				}
			}
			scope:recipient = {
				OR = {
					has_relation_guardian = scope:actor
					is_courtier_of = scope:actor
					is_imprisoned_by = scope:actor
				}
			}
		}
	}
	is_valid_showing_failures_only = {
		scope:recipient = {
			age >= 3
		}
	}

	cooldown_against_recipient = { years = 15 }

	auto_accept = {
		#TODO: auto-accept for already having secret religion? is a mess to work out
		OR = {
			scope:recipient = { is_imprisoned_by = scope:actor }
			custom_description = {
				text = "spending_hook"
				subject = scope:actor
				object = scope:recipient
				scope:hook = yes
				scope:actor = { has_strong_hook = scope:recipient }
			}
			scope:recipient = {
				has_relation_ward = scope:actor
				age <= 6
			}
		}
	}

	on_accept = {
		scope:actor = {
			send_interface_message = {
				type = event_generic_good
				title = secret_religion_demand_secret_conversion_accept_t
				desc = secret_religion_demand_secret_conversion_accept_desc
				right_icon = scope:recipient

				scope:recipient = {
					secret_religion_secretly_convert_to_same = {
						OLD = scope:actor
					}
					if = {
						limit = {
							is_imprisoned_by = scope:actor
						}
						release_from_prison = yes
					}
					every_secret = {
						limit = {
							secret_type = secret_religion
						}
						disable_exposure_by = scope:actor
						reveal_to = scope:actor
					}
				}
				every_secret = {
					limit = {
						secret_type = secret_religion
					}
					reveal_to = scope:recipient
					disable_exposure_by = scope:recipient
				}
			}
			if = {
				limit = {
					scope:hook = yes
				}
				use_hook = scope:recipient
			}
		}
	}

	on_decline = {
		scope:actor = {
			send_interface_message = {
				type = event_generic_bad
				title = secret_religion_demand_secret_conversion_refuse_t
				desc = secret_religion_demand_secret_conversion_refuse_desc
				right_icon = scope:recipient

				every_secret = {
					limit = {
						secret_type = secret_religion
					}
					reveal_to = scope:recipient
				}
				reverse_add_opinion = {
					modifier = insult_opinion
					opinion = -20
					target = scope:recipient
				}
			}
		}
	}

	# Use hook
	send_option = {
		is_valid = {
			scope:actor = {
				has_usable_hook = scope:recipient
			}
			NOT = {
				scope:recipient = { is_imprisoned_by = scope:actor }
			}
		}
		flag = hook
		localization = SCHEME_HOOK
	}
	should_use_extra_icon = {
		scope:actor = { has_usable_hook = scope:recipient }
	}
	extra_icon = "gfx/interface/icons/character_interactions/hook_icon.dds"

	send_options_exclusive = no

	ai_accept = {
		base = 0
		secret_religion_demand_false_conversion_default_modifier = yes
	}
}
