on_game_start = {
	on_actions = {
		on_government_assign_start
		set_vassal_contracts_and_laws
	}
}

on_government_assign_start = {
	effect = {
		set_global_variable = {
			name = Gov_is_loaded
			value = yes
		}
		religion:kushitism_religion = {
			every_faith = {
				remove_doctrine = doctrine_theocracy_temporal
				add_doctrine = doctrine_imperial_head
			}
		}
		religion:hellenism_religion = {
			every_faith = {
				remove_doctrine = doctrine_theocracy_temporal
				add_doctrine = doctrine_imperial_head
			}
		}
		every_independent_ruler = {
			limit = {
				primary_title.tier = tier_empire
				NOT = { faith = { has_doctrine = unreformed_faith_doctrine } }
			}

			save_scope_as = current_emperor

			new_official_imperial_faith_effect_skip_effects = { EMPIRE = scope:current_emperor.primary_title FAITH = scope:current_emperor.faith }
		}

		every_ruler = {
			if = {
				limit = {
					has_religion = religion:islam_religion
					NOT = {
						has_government = tribal_government
					}
				}
				if = {
					limit = {
						faith.religious_head = THIS
					}
					change_government = caliphate_government
				}
				else_if = {
					limit = {
						capital_county = {
							OR = {
								empire = {
									THIS = title:e_arabia
								}
								empire = {
									THIS = title:e_persia
								}
								empire = {
									THIS = title:e_spain
								}
								kingdom = {
									THIS = title:k_sindh
								}
							}
						}

					}
					change_government = muslim_government
				}
			}
			if = {
				limit = {
					is_independent_ruler = yes
					OR = {
						culture = culture:mon
						culture = culture:pyu
					}
					OR = {
						primary_title.empire = title:e_burma
						primary_title.empire = title:e_angkor
					}
				}
				change_government = city_state_government
				if = {
					limit = { NOT = { has_realm_law = crown_authority_0 } }
					add_realm_law_skip_effects = crown_authority_0
				}

				if = {
					limit = { highest_held_title_tier > tier_county }

					save_scope_as = liege

					every_held_title = {
						limit = {
							tier = tier_county
							NOT = { this = scope:liege.capital_county }
						}

						save_scope_as = title

						create_character = {
							template = pool_sea_game_start_stewardship
							faith = scope:liege.faith
							culture = scope:liege.culture
							gender = male
	                        dynasty = generate
	                        location = scope:title.title_province
							save_scope_as = new_character
						}

						create_title_and_vassal_change = {
							type = granted
							save_scope_as = change
							add_claim_on_loss = no
						}
						scope:title = {
							change_title_holder = {
								holder = scope:new_character
								change = scope:change
							}
						}
						resolve_title_and_vassal_change = scope:change

						hidden_effect = {
							scope:new_character = {
								change_government = city_state_government
								if = {
									limit = { NOT = { has_realm_law = crown_authority_0 } }
									add_realm_law_skip_effects = crown_authority_0
								}
							}
						}
					}
				}
			}
		}
		if = {
			limit = {
				title:k_andalusia = {
					is_title_created = yes
				}
			}
			title:k_andalusia.holder = {
				change_government = caliphate_government
			}
		}
		if = {
			limit = {
				title:d_gotland = {
					is_title_created = yes
				}
			}
			title:d_gotland.holder = {
				change_government = city_state_government
			}
		}
		title:c_socotra.holder = {
			change_government = city_state_government
		}
		title:c_mogadishu.holder = {
			change_government = city_state_government
		}
		title:c_gao.holder = {
			change_government = city_state_government
		}
		title:c_jenne.holder = {
			change_government = city_state_government
		}
		if = {
			limit = {
				current_date <= 900.1.1
			}
			title:d_bulgaria.holder = {
				change_government = autocratic_government
			}
		}
		if = {
			limit = {
				current_date >= 900.1.1
			}
			title:d_duklja.holder = {
				change_government = autocratic_government
				every_vassal_or_below = {
					change_government = autocratic_government
				}
			}
		}
		title:c_napoli.holder = {
			change_government = autocratic_government
		}
		if = {
			limit = {
				title:e_byzantium = {
					is_title_created = yes
				}
			}
			title:e_byzantium.holder = {
				change_government = imperial_government
				every_vassal_or_below = {
					limit = {
						has_government = feudal_government
					}
					if = {
						limit = {
							highest_held_title_tier > tier_county
						}
						change_government = imperial_government
					}
					else_if = {
						limit = {
							highest_held_title_tier = tier_county
						}
						change_government = roman_government
					}
				}
			}
		}
		if = {
			limit = {
				title:e_byzantium = {
					is_title_created = yes
				}
			}
			title:e_byzantium.holder = {
				random_held_title = {
					limit = {
						AND = {
							tier = tier_county
							NOT = {
								THIS = PREV.capital_county
							}
							NOT = {
								title_province = {
									has_holding_type = estate_holding
								}
							}
						}
					}
					title_province = {
						set_holding_type = estate_holding
					}
				}
				random_held_title = {
					limit = {
						AND = {
							tier = tier_county
							NOT = {
								THIS = PREV.capital_county
							}
							NOT = {
								title_province = {
									has_holding_type = estate_holding
								}
							}
						}
					}
					title_province = {
						set_holding_type = estate_holding
					}
				}
				every_vassal_or_below = {
					limit = {
						OR = {
							has_government = feudal_government
							has_government = imperial_government
							has_government = roman_government
						}
					}
					if = {
						limit = {
							highest_held_title_tier > tier_county
						}
						change_government = imperial_government
						random_held_title = {
							limit = {
								AND = {
									tier = tier_county
									NOT = {
										THIS = PREV.capital_county
									}
									NOT = {
										title_province = {
											has_holding_type = estate_holding
										}
									}
								}
							}
							title_province = {
								set_holding_type = estate_holding
							}
						}
					}
					else_if = {
						limit = {
							highest_held_title_tier = tier_county
						}
						every_held_title = {
							limit = {
								AND = {
									tier = tier_county
									NOT = {
										title_province = {
											has_holding_type = estate_holding
										}
									}
								}
							}
							title_province = {
								set_holding_type = estate_holding
							}
						}
						change_government = roman_government

					}
				}
			}
		}
		if = {
			limit = {
				title:d_kabul = {
					is_title_created = yes
				}
				current_date <= 900.1.1
			}
			title:d_kabul.holder = {
				change_government = city_state_government
				every_vassal_or_below = {
					change_government = city_state_government
				}
			}
		}
		if = {
			limit = {
				title:c_ghur = {
					is_title_created = yes
				}
				current_date <= 900.1.1
			}
			title:c_ghur.holder = {
				change_government = city_state_government
			}
		}
		if = {
			limit = {
				title:c_kasmira = {
					is_title_created = yes
				}
				current_date <= 900.1.1
			}
			title:c_kasmira.holder = {
				change_government = city_state_government
			}
		}
		if = {
			limit = {
				title:d_multan = {
					is_title_created = yes
				}
				current_date <= 900.1.1
			}
			title:d_multan.holder = {
				change_government = city_state_government
			}
		}
		if = {
			limit = {
				title:c_nandana = {
					is_title_created = yes
				}
				current_date <= 900.1.1
			}
			title:c_nandana.holder = {
				change_government = city_state_government
			}
		}
		title:k_sicily = {
			every_in_de_jure_hierarchy = {
				limit = {
					is_title_created = yes
				}
				holder = {
					if = {
						limit = {
							has_government = caliphate_government
						}
						change_government = clan_government
					}
				}
			}
		}

		every_ruler = {
			save_scope_as = ruler

			if = {
				limit = {
					has_government = tribal_government
					exists = capital_county
					culture = { has_cultural_tradition = tradition_horse_lords }
					NOR = {
						culture = culture:tuyuhun
						culture = culture:shatuo
					}
				}
				change_government = nomadic_government
			}
			if = {
				limit = {
					exists = capital_county
					OR = {
						has_government = tribal_government
						has_government = feudal_government
					}
					OR = {
						culture = culture:uyghur
						culture = culture:kirghiz
					}
				}
				if = {
					limit = { game_start_date < 877.1.1 }
					change_government = nomadic_government
				}
				else = {
					change_government = clan_government
				}
			}
			if = {
				limit = {
					exists = capital_county
					capital_county.title_province = {
						OR = {
							geographical_region = world_southeast_asia
							geographical_region = world_burma
						}
					}
					has_government = feudal_government
					OR = {
						religion = religion:hinduism_religion
						religion = religion:buddhism_religion
						religion = religion:jainism_religion
					}
					NOT = { faith = faith:lamaism }
				}
				change_government = mandala_government
				add_realm_law_skip_effects = single_heir_succession_law

				every_vassal = {
					limit = {
						highest_held_title_tier = tier_barony
						OR = {
							has_government = feudal_government
							has_government = republic_government
						}
					}
					change_government = mandala_government
					add_realm_law_skip_effects = single_heir_succession_law
				}
			}
			if = {
				limit = {
					exists = capital_county
					capital_county.title_province = { geographical_region = world_india }
					has_government = feudal_government
					OR = {
						culture = { has_cultural_pillar = heritage_indo_aryan }
						culture = { has_cultural_pillar = heritage_dravidian }
						culture = { has_cultural_pillar = heritage_burman }
					}
					OR = {
						religion = religion:hinduism_religion
						religion = religion:buddhism_religion
						religion = religion:jainism_religion
					}
					NOT = { faith = faith:lamaism }
				}
				change_government = mandala_government
				add_realm_law_skip_effects = single_heir_succession_law

				every_vassal = {
					limit = {
						highest_held_title_tier = tier_barony
						OR = {
							has_government = feudal_government
							has_government = republic_government
						}
					}
					change_government = mandala_government
					add_realm_law_skip_effects = single_heir_succession_law
				}
			}
			if = {
				limit = {
					has_government = tribal_government
					is_independent_ruler = yes
					highest_held_title_tier <= tier_duchy
					culture = {
						OR = {
							AND = {
								has_cultural_tradition = tradition_collective_lands
								NOT = {
									this = culture:muong
									has_cultural_parameter = heritage_group_austronesian
								}
							}
							has_cultural_pillar = heritage_papuan
							has_cultural_pillar = heritage_kaurareg
							this = culture:aslian
						}
					}
				}

				capital_county = { save_scope_as = commune_capital }
				change_government = anarchist_government
				# Create a titular duchy
				# scope:new_title

				create_title_and_vassal_change = {
					type = created
					save_scope_as = change
					add_claim_on_loss = no
				}

				if = {
					limit = { highest_held_title_tier < tier_duchy }
					create_dynamic_title = {
						tier = duchy
						name = ANARCHIST_TITLE_NAME
					}
					scope:new_title = {
						set_destroy_on_gain_same_tier = yes
						set_no_automatic_claims = yes
						set_can_be_named_after_dynasty = no
						change_title_holder = {
							holder = scope:ruler
							change = scope:change
						}
					}
					resolve_title_and_vassal_change = scope:change

					# Generate a new CoA
					## We do this in a separate block so that the effect has time to see that the title has a holder, since it'll error otherwise.
					scope:new_title = {
						generate_coa = yes
						set_color_from_title = scope:commune_capital
					}
				}

				add_realm_law_skip_effects = single_heir_dynasty_house
				primary_title = {
					add_title_law = anarchist_elective_succession_law
				}
				every_held_title = {
					limit = { tier = tier_county }
					save_scope_as = title
					scope:ruler = { trigger_event = sea_title_event.2001 }
				}
			}
		}

		# Fix authority laws
		every_ruler = {
			if = {
				limit = {
					has_government = nomadic_government
				}

				if = {
					limit = { NOT = { has_realm_law = nomadic_authority_0 } }
					add_realm_law_skip_effects = nomadic_authority_0
				}
				if = {
					limit = { has_realm_law = tribal_authority_0 }
					remove_realm_law = tribal_authority_0
				}
				if = {
					limit = { has_realm_law = tribal_authority_1 }
					remove_realm_law = tribal_authority_1
				}
				if = {
					limit = { has_realm_law = tribal_authority_2 }
					remove_realm_law = tribal_authority_2
				}
				if = {
					limit = { has_realm_law = tribal_authority_3 }
					remove_realm_law = tribal_authority_3
				}
			}
			else_if = {
				limit = {
					has_government = mandala_government
				}

				if = {
					limit = { NOT = { has_realm_law = mandala_authority_0 } }
					add_realm_law_skip_effects = mandala_authority_0
				}
				if = {
					limit = { has_realm_law = crown_authority_0 }
					remove_realm_law = crown_authority_0
				}
				if = {
					limit = { has_realm_law = crown_authority_1 }
					remove_realm_law = crown_authority_1
				}
				if = {
					limit = { has_realm_law = crown_authority_2 }
					remove_realm_law = crown_authority_2
				}
				if = {
					limit = { has_realm_law = crown_authority_3 }
					remove_realm_law = crown_authority_3
				}
			}
			else_if = {
				limit = {
					has_government = anarchist_government
				}

				if = {
					limit = { NOT = { has_realm_law = stateless_authority_0 } }
					add_realm_law_skip_effects = stateless_authority_0
				}
				if = {
					limit = { has_realm_law = tribal_authority_0 }
					remove_realm_law = tribal_authority_0
				}
				if = {
					limit = { has_realm_law = tribal_authority_1 }
					remove_realm_law = tribal_authority_1
				}
				if = {
					limit = { has_realm_law = tribal_authority_2 }
					remove_realm_law = tribal_authority_2
				}
				if = {
					limit = { has_realm_law = tribal_authority_3 }
					remove_realm_law = tribal_authority_3
				}
			}
		}
	}
}

set_vassal_contracts_and_laws = {
	effect = {
		if = {
			limit = {
				title:e_byzantium = {
					is_title_created = yes
				}
			}
			title:e_byzantium.holder = {
				add_realm_law_skip_effects = imperial_authority_2
				every_vassal_or_below = {
					limit = {
						has_government = imperial_government
					}

					add_realm_law_skip_effects = military_office_authority_0
				}
			}
		}
		if = {
			limit = {
				title:e_celestia_china = {
					is_title_created = yes
				}
			}
			title:e_celestia_china.holder = {
				# add_realm_law_skip_effects = imperial_authority_2
			}
		}
	}
}
