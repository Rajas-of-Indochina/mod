# Called from code after history generation
# Empty scope
on_game_start = {
    on_actions = {
        holy_site_buildings_on_game_start
        # holy_site_descriptions_on_game_start
        add_right_to_rule_doctrines_on_game_start
        reorganize_chinese_realms_on_game_start
        add_disloyal_subjects_tradition_on_game_start
    }
}

on_game_start_after_lobby = {
    on_actions = {
        ruler_popup_events
        # tibetan_struggle_on_game_start
        # chinese_struggle_on_game_start
        sea_set_cultural_acceptance
        on_yearly_assign_culture_faith
    }
}

######

# holy_site_descriptions_on_game_start = {
#     effect = {
#
#         title:b_albay = {
#             set_variable = {
#                 name = holy_site_description
#                 value = flag:holy_site_mount_mayon_description
#             }
#         }
#     }
# }

######

sea_set_cultural_acceptance = {
    effect = {
        culture:yi = {
            change_cultural_acceptance = {
                target = culture:bai
                value = 50
                desc = cultural_acceptance_historical_relations
            }
            change_cultural_acceptance = {
                target = culture:burmese
                value = 40
                desc = cultural_acceptance_historical_relations
            }
        }
        culture:malay = {
            change_cultural_acceptance = {
                target = culture:khmer
                value = 30
                desc = cultural_acceptance_historical_relations
            }
        }
    }
}

######

add_right_to_rule_doctrines_on_game_start = {
    effect = {
        every_religion_global = {
            ## Christian religions except insular get Divine Right
            if = {
                limit = { this = religion:christianity_religion }
                every_faith = {
                    limit = {
                        NOR = {
                            has_doctrine = doctrine_right_to_rule_material
                            has_doctrine = doctrine_right_to_rule_divine
                        }
                    }

                    if = {
                        limit = { this = faith:insular_celtic }
                        add_doctrine = doctrine_right_to_rule_material
                    }
                    else = {
                        add_doctrine = doctrine_right_to_rule_divine
                    }
                }
            }
            ## Judaism and Zoroastrianism get Divine Right
            else_if = {
                limit = {
                    OR = {
                        this = religion:judaism_religion
                        this = religion:zoroastrianism_religion
                    }
                }
                every_faith = {
                    limit = {
                        NOR = {
                            has_doctrine = doctrine_right_to_rule_material
                            has_doctrine = doctrine_right_to_rule_divine
                        }
                    }

                    add_doctrine = doctrine_right_to_rule_divine
                }
            }
            ## Hindu, Buddhist, Jain, and Taoist get Divine Right (Will be mandala except Tao)
            else_if = {
                limit = {
                    OR = {
                        this = religion:taoism_religion
                    }
                }
                every_faith = {
                    limit = {
                        NOR = {
                            has_doctrine = doctrine_right_to_rule_material
                            has_doctrine = doctrine_right_to_rule_divine
                        }
                    }

                    add_doctrine = doctrine_right_to_rule_divine
                }
            }
            else_if = {
                limit = {
                    OR = {
                        this = religion:hinduism_religion
                        this = religion:jainism_religion
                        this = religion:buddhism_religion
                    }
                }
                every_faith = {
                    limit = {
                        NOR = {
                            has_doctrine = doctrine_right_to_rule_material
                            has_doctrine = doctrine_right_to_rule_divine
                            has_doctrine = doctrine_right_to_rule_rajadharma
                        }
                    }

                    add_doctrine = doctrine_right_to_rule_rajadharma
                }
            }
            ## Everyone else gets Material Right
            else = {
                every_faith = {
                    limit = {
                        NOT = { has_doctrine = unreformed_faith_doctrine }
                        NOR = {
                            has_doctrine = doctrine_right_to_rule_material
                            has_doctrine = doctrine_right_to_rule_divine
                        }
                    }

                    add_doctrine = doctrine_right_to_rule_material
                }
            }
        }
    }
}

######

ruler_popup_events = {
    effect = {
        every_ruler = {
            if = {
                limit = { is_ai = no }
                trigger_event = {
                    id = ruler_popups.0001
                }
            }
        }
    }
}

######

tibetan_struggle_on_game_start = {
    effect = {
        if = {
            limit = {
                game_start_date >= 842.1.1
            }
            start_struggle = {
                struggle_type = tibetan_struggle
                start_phase = struggle_iberia_phase_opportunity # TODO: We should add phase changes in History to get two different entry point
            }
        }
    }
}
chinese_struggle_on_game_start = {
    effect = {
        start_struggle = {
            struggle_type = chinese_struggle
            start_phase = struggle_iberia_phase_opportunity # TODO: We should add phase changes in History to get two different entry point
        }
    }
}

#####

# Warning: Jank
reorganize_chinese_realms_on_game_start = {
    effect = {
        title:e_celestia_china.holder = {
            every_vassal = {
                limit = {
                    highest_held_title_tier = tier_kingdom
                    NOT = { primary_title = title:k_jinghai }
                }

                primary_title = { save_scope_as = old_title }

                create_title_and_vassal_change = {
                    type = created
                    save_scope_as = change
                    add_claim_on_loss = no
                }
                create_dynamic_title = {
                    tier = duchy
                    name = NEW_CREATED_TITLE_NAME
                }

                scope:new_title = {
                    set_no_automatic_claims = yes
                    set_can_be_named_after_dynasty = no
                    change_title_holder = {
                        holder = prev
                        change = scope:change
                    }
                }
                resolve_title_and_vassal_change = scope:change
                scope:new_title = {
                    generate_coa = yes
                    set_color_from_title = scope:old_title
                }

                destroy_title = scope:old_title
            }
        }
    }
}

#####

add_disloyal_subjects_tradition_on_game_start = {
    effect = {
        culture:zhangzhung = {
            add_culture_tradition = tradition_disloyal_subjects
        }
        culture:sumpa = {
            add_culture_tradition = tradition_disloyal_subjects
        }
        culture:bodpa = {
            add_culture_tradition = tradition_disloyal_subjects
        }
        culture:tsangpa = {
            add_culture_tradition = tradition_disloyal_subjects
        }
        culture:lhomon = {
            add_culture_tradition = tradition_disloyal_subjects
        }
        culture:tani = {
            add_culture_tradition = tradition_disloyal_subjects
        }
    }
}